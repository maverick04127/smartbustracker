<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Bus Tracker</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #1e88e5, #42a5f5);
      min-height: 100vh;
    }

    .card {
      background: white;
      max-width: 420px;
      margin: 30px auto;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
    }

    p.subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background: #1e88e5;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background: #1565c0;
    }

    #mapPage {
      height: 100vh;
      display: none;
    }

    .eta-box {
      font-size: 16px;
    }
  </style>
</head>
<body>

<!-- HOME / FORM PAGE -->
<div id="formPage" class="card">
  <h2>ðŸšŒ Smart Bus Tracker</h2>
  <p class="subtitle">Track your bus in real-time with alerts</p>

  <label>State (type to search)</label>
  <input list="states" id="state" placeholder="Start typing your state..." />
  <datalist id="states">
    <option value="Andhra Pradesh">
    <option value="Arunachal Pradesh">
    <option value="Assam">
    <option value="Bihar">
    <option value="Chhattisgarh">
    <option value="Goa">
    <option value="Gujarat">
    <option value="Haryana">
    <option value="Himachal Pradesh">
    <option value="Jharkhand">
    <option value="Karnataka">
    <option value="Kerala">
    <option value="Madhya Pradesh">
    <option value="Maharashtra">
    <option value="Manipur">
    <option value="Meghalaya">
    <option value="Mizoram">
    <option value="Nagaland">
    <option value="Odisha">
    <option value="Punjab">
    <option value="Rajasthan">
    <option value="Sikkim">
    <option value="Tamil Nadu">
    <option value="Telangana">
    <option value="Tripura">
    <option value="Uttar Pradesh">
    <option value="Uttarakhand">
    <option value="West Bengal">
    <option value="Delhi">
    <option value="Jammu and Kashmir">
    <option value="Ladakh">
    <option value="Puducherry">
    <option value="Chandigarh">
    <option value="Andaman and Nicobar Islands">
    <option value="Dadra and Nagar Haveli and Daman and Diu">
    <option value="Lakshadweep">
  </datalist>

  <label>Your City</label>
  <input id="location" placeholder="e.g. Bengaluru" />

  <label>Pickup Location (Bus Stop / Landmark)</label>
  <input id="pickup" placeholder="e.g. Main Gate, Hostel Stop" />

  <label>Bus Type</label>
  <select id="busType">
    <option value="government">Government</option>
    <option value="college">College</option>
    <option value="other">Other</option>
  </select>

  <label>Bus Number</label>
  <input id="busNumber" placeholder="e.g. 101" />

  <button onclick="startTracking()">Start Tracking</button>
</div>

<!-- MAP PAGE -->
<div id="mapPage"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let alerted = false;

function startTracking() {
  const state = document.getElementById('state').value.trim();
  const city = document.getElementById('location').value.trim();

  if (state === '' || city === '') {
    alert('You have to fill the details.');
    return;
  }

  document.getElementById('formPage').style.display = 'none';
  document.getElementById('mapPage').style.display = 'block';

  navigator.geolocation.getCurrentPosition((position) => {
    const userLat = position.coords.latitude;
    const userLon = position.coords.longitude;

    const pickupLat = userLat + 0.001;
    const pickupLon = userLon + 0.001;

    map = L.map('mapPage').setView([userLat, userLon], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    L.marker([pickupLat, pickupLon]).addTo(map)
      .bindPopup('Your Pickup Location')
      .openPopup();

    let busLat = pickupLat + 0.003;
    let busLon = pickupLon + 0.003;

    const busMarker = L.circleMarker([busLat, busLon], {
      radius: 10,
      color: 'red',
      fillColor: 'red',
      fillOpacity: 0.9
    }).addTo(map);

    const etaControl = L.control({ position: 'bottomleft' });
    etaControl.onAdd = function () {
      const div = L.DomUtil.create('div', 'eta-box');
      div.style.background = 'white';
      div.style.padding = '10px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
      div.innerHTML = '<strong>ETA:</strong> Calculating...';
      return div;
    };
    etaControl.addTo(map);

    let blink = false;
    function startBlinking() {
      setInterval(() => {
        blink = !blink;
        busMarker.setStyle({ fillOpacity: blink ? 0.2 : 0.9 });
      }, 500);
    }

    function moveBus() {
      busLat -= 0.0001;
      busLon -= 0.0001;
      busMarker.setLatLng([busLat, busLon]);

      const distance = map.distance([pickupLat, pickupLon], [busLat, busLon]);
      const speed = 8;
      const eta = Math.max(Math.round(distance / speed / 60), 1);

      document.querySelector('.eta-box').innerHTML = '<strong>ETA:</strong> ' + eta + ' min';

      if (eta <= 10 && !alerted) {
        alert('ðŸšŒ Bus is arriving in ' + eta + ' minutes!');
        startBlinking();
        alerted = true;
      }
    }

    setInterval(moveBus, 3000);
  }, () => alert('Location permission denied'));
}
</script>
</body>
</html>
